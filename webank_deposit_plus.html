<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活期+plus 调仓决策工具 (专业版)</title>
    <!-- 引入 Tailwind CSS 以实现快速美观的样式设计 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js 用于绘制图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 html2canvas 用于将HTML元素转为图片 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* 自定义字体和基础样式 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        /* 表格输入框样式 */
        .input-cell {
            @apply w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition;
        }
        /* 按钮悬浮效果 */
        .btn-hover-effect {
            @apply transition duration-300 ease-in-out transform hover:-translate-y-1;
        }
        /* 用于导出卡片的样式，在页面上不可见 */
        #export-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 750px; /* 增加宽度以容纳新列 */
            background-color: white;
            padding: 20px;
            font-family: 'Inter', sans-serif;
            border: 1px solid #e5e7eb;
        }
        /* 自定义美化toggle开关 */
        .toggle-checkbox:checked {
            @apply bg-green-500;
            right: 0;
        }
        .toggle-checkbox:checked + .toggle-label {
            @apply bg-green-500;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">活期+plus 调仓决策工具</h1>
            <p class="text-gray-600 mt-2">一个帮您计算和比较产品近期收益的智能助手 (数据会自动保存)</p>
        </header>

        <div class="bg-white p-4 rounded-lg shadow-md mb-8 border border-gray-200">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">计算周期信息</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="p-3 bg-indigo-50 rounded-lg"><p class="text-sm text-indigo-700">最新净值日期 (昨日)</p><p id="end-date-display" class="text-lg font-bold text-indigo-900">-</p></div>
                <div class="p-3 bg-green-50 rounded-lg"><p class="text-sm text-green-700">起始净值日期 (7个交易日前)</p><p id="start-date-display" class="text-lg font-bold text-green-900">-</p></div>
                <div class="p-3 bg-amber-50 rounded-lg"><p class="text-sm text-amber-700">总计息天数</p><p id="interval-days-display" class="text-lg font-bold text-amber-900">-</p></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8 border border-gray-200">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">数据输入</h2>
            <div class="overflow-x-auto">
                <table class="w-full min-w-[900px]">
                    <thead>
                        <tr class="border-b">
                            <th class="text-center p-2 font-medium text-gray-600 w-[10%]">操作</th>
                            <th id="sort-by-name-header" class="text-left p-2 font-medium text-gray-600 w-[25%] cursor-pointer hover:bg-gray-100 transition rounded-t-lg">
                                <div class="flex items-center gap-1">
                                    <span>产品名称</span>
                                    <span id="sort-indicator"></span>
                                </div>
                            </th>
                            <th class="text-left p-2 font-medium text-gray-600 w-[15%]">持有金额</th>
                            <th class="text-left p-2 font-medium text-gray-600 w-[15%]">成立以来年化(%)</th>
                            <th class="text-left p-2 font-medium text-gray-600 w-[12.5%]">起始净值 (<span id="start-date-label"></span>)</th>
                            <th class="text-left p-2 font-medium text-gray-600 w-[12.5%]">最新净值 (<span id="end-date-label"></span>)</th>
                            <th class="text-center p-2 font-medium text-gray-600 w-[10%]">是否售罄</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body"></tbody>
                </table>
            </div>
            <div class="mt-4 flex flex-wrap items-center gap-4">
                <button id="add-row-btn" class="flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 btn-hover-effect">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    增加一行
                </button>
                <label for="import-csv-input" class="flex items-center justify-center gap-2 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-teal-700 btn-hover-effect cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    导入数据 (CSV)
                </label>
                <input type="file" id="import-csv-input" accept=".csv" class="hidden">
                 <button id="export-csv-btn" class="flex items-center justify-center gap-2 bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-orange-600 btn-hover-effect">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    导出数据 (CSV)
                </button>
                <button id="calculate-btn" class="flex items-center justify-center gap-2 bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-green-700 btn-hover-effect">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10H8L12 4L16 10H12V20Z"></path></svg>
                    计算并保存
                </button>
            </div>
        </div>

        <div id="results-section" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-md mb-8 border border-gray-200">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-700">综合评分排名</h2>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="toggle-amount-visibility" class="toggle-checkbox relative w-10 h-5 bg-gray-300 rounded-full appearance-none cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none shadow-inner before:w-4 before:h-4 before:bg-white before:rounded-full before:absolute before:top-1/2 before:left-0.5 before:-translate-y-1/2 before:transform before:shadow before:transition-transform before:duration-200 checked:before:translate-x-5">
                            <label for="toggle-amount-visibility" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">隐藏金额</label>
                        </div>
                        <button id="export-table-btn" class="flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 btn-hover-effect">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            导出排名表格
                        </button>
                        <button id="export-chart-btn" class="flex items-center justify-center gap-2 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-purple-700 btn-hover-effect">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                            导出评分图表
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="border-b">
                                <th class="text-center p-2 font-medium text-gray-600 w-[8%]">排名</th>
                                <th class="text-left p-2 font-medium text-gray-600 w-[28%]">产品名称</th>
                                <th class="text-right p-2 font-medium text-gray-600 w-[12%]">持有金额</th>
                                <th class="text-right p-2 font-medium text-gray-600 w-[14%]">成立以来(%)</th>
                                <th class="text-right p-2 font-medium text-gray-600 w-[14%]">近7日(%)</th>
                                <th class="text-right p-2 font-medium text-gray-600 w-[14%]">综合分数</th>
                                <th class="text-center p-2 font-medium text-gray-600 w-[10%]">售罄</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-8 mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">综合分数对比图</h2>
                    <canvas id="yield-chart"></canvas>
                </div>
                <div id="institution-chart-container" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">机构持仓分析</h2>
                    <div class="relative mx-auto" style="max-width: 650px; max-height: 650px;">
                        <canvas id="institution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let intervalDays = 0;
            let chartInstance = null;
            let institutionChartInstance = null;
            let nameSortDirection = 'asc';
            let lastCalculatedResults = [];
            const holidays2025 = ['2025-01-01', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', '2025-02-03', '2025-04-04', '2025-05-01', '2025-05-02', '2025-05-03', '2025-05-31', '2025-10-01', '2025-10-02', '2025-10-03', '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-07'].map(d => new Date(d));
            const LOCAL_STORAGE_KEY = 'yieldAnalyzerData';
            const AMOUNT_VISIBILITY_KEY = 'amountVisibility';

            const isTradingDay = (d) => {
                if (d.getDay() === 0 || d.getDay() === 6) return false;
                const s = d.toISOString().split('T')[0];
                return !holidays2025.some(h => h.toISOString().split('T')[0] === s);
            };

            const findStartDateAndInterval = (endDate) => {
                let tradingDaysFound = 0, currentSearchDate = new Date(endDate);
                currentSearchDate.setDate(currentSearchDate.getDate() - 1);
                while (tradingDaysFound < 7) {
                    if (isTradingDay(currentSearchDate)) tradingDaysFound++;
                    if (tradingDaysFound === 7) break;
                    currentSearchDate.setDate(currentSearchDate.getDate() - 1);
                }
                const interval = Math.round((endDate - currentSearchDate) / (1000 * 60 * 60 * 24));
                return { startDate: currentSearchDate, interval };
            };

            const setupDates = () => {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - 1);
                const { startDate, interval } = findStartDateAndInterval(endDate);
                intervalDays = interval;
                const formatDate = (d) => d.toISOString().split('T')[0];
                document.getElementById('end-date-display').textContent = formatDate(endDate);
                document.getElementById('start-date-display').textContent = formatDate(startDate);
                document.getElementById('interval-days-display').textContent = `${interval} 天`;
                document.getElementById('start-date-label').textContent = formatDate(startDate);
                document.getElementById('end-date-label').textContent = formatDate(endDate);
            };
            
            const updateRowButtonsState = () => {
                const rows = document.querySelectorAll('#product-table-body tr');
                rows.forEach((row, index) => {
                    const pinBtn = row.querySelector('.pin-to-top-btn');
                    const upBtn = row.querySelector('.move-up-btn');
                    const downBtn = row.querySelector('.move-down-btn');
                    if (pinBtn) pinBtn.disabled = (index === 0);
                    if (upBtn) upBtn.disabled = (index === 0);
                    if (downBtn) downBtn.disabled = (index === rows.length - 1);
                });
            };

            const createTableRow = (data = {}) => {
                const { name = '', holdingAmount = '', sinceInceptionYield = '', startVal = '', endVal = '', isSoldOut = false } = data;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-1 text-center">
                        <div class="flex justify-center items-center gap-1">
                             <button class="pin-to-top-btn text-gray-400 hover:text-green-600 disabled:opacity-30 disabled:cursor-not-allowed transition" title="置顶">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 3h14"/><path d="M12 17V7"/><path d="m8 11 4-4 4 4"/></svg>
                            </button>
                            <button class="move-up-btn text-gray-400 hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed transition" title="上移">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
                            </button>
                            <button class="move-down-btn text-gray-400 hover:text-blue-600 disabled:opacity-30 disabled:cursor-not-allowed transition" title="下移">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                            </button>
                            <button class="delete-row-btn text-gray-400 hover:text-red-600 transition" title="删除">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </td>
                    <td class="p-1"><input type="text" class="input-cell product-name" placeholder="例如：悦慧7D" value="${name}"></td>
                    <td class="p-1"><input type="number" class="input-cell holding-amount" placeholder="例如：10000" value="${holdingAmount}"></td>
                    <td class="p-1"><input type="number" step="0.01" class="input-cell since-inception-yield" placeholder="例如：3.53" value="${sinceInceptionYield}"></td>
                    <td class="p-1"><input type="number" step="0.0001" class="input-cell start-value" placeholder="例如：1.0812" value="${startVal}"></td>
                    <td class="p-1"><input type="number" step="0.0001" class="input-cell end-value" placeholder="例如：1.0825" value="${endVal}"></td>
                    <td class="p-1 text-center"><input type="checkbox" class="form-checkbox h-5 w-5 text-red-600 rounded sold-out-checkbox" ${isSoldOut ? 'checked' : ''}></td>
                `;
                document.getElementById('product-table-body').appendChild(tr);
                updateRowButtonsState();
            };
            
            const saveDataToLocalStorage = () => {
                const rows = document.querySelectorAll('#product-table-body tr');
                const dataToSave = [];
                rows.forEach(row => {
                    const name = row.querySelector('.product-name').value.trim();
                    const holdingAmount = row.querySelector('.holding-amount').value;
                    const sinceInceptionYield = row.querySelector('.since-inception-yield').value;
                    const startVal = row.querySelector('.start-value').value;
                    const endVal = row.querySelector('.end-value').value;
                    const isSoldOut = row.querySelector('.sold-out-checkbox').checked;
                    if(name) {
                        dataToSave.push({ name, holdingAmount, sinceInceptionYield, startVal, endVal, isSoldOut });
                    }
                });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            };

            const loadDataFromLocalStorage = () => {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                document.getElementById('product-table-body').innerHTML = '';
                
                if (savedData !== null) {
                    const products = JSON.parse(savedData);
                    if (products.length > 0) {
                        products.forEach(p => createTableRow(p));
                    }
                } else {
                    createTableRow({name: '华夏理财 悦慧7D', holdingAmount: 10000, sinceInceptionYield: '3.36', startVal: '1.0820', endVal: '1.0825', isSoldOut: false});
                    createTableRow({name: '浦银理财 周周鑫8号', holdingAmount: 5000, sinceInceptionYield: '3.65', startVal: '1.0710', endVal: '1.0718', isSoldOut: true});
                }
                updateRowButtonsState();
            };

            const handleTableActions = (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                
                const row = target.closest('tr');
                if (target.classList.contains('delete-row-btn')) {
                    row.remove();
                } else if (target.classList.contains('move-up-btn')) {
                    const prevRow = row.previousElementSibling;
                    if (prevRow) {
                        row.parentNode.insertBefore(row, prevRow);
                    }
                } else if (target.classList.contains('move-down-btn')) {
                    const nextRow = row.nextElementSibling;
                    if (nextRow) {
                        row.parentNode.insertBefore(nextRow, row);
                    }
                } else if (target.classList.contains('pin-to-top-btn')) {
                    row.parentNode.insertBefore(row, row.parentNode.firstChild);
                }
                updateRowButtonsState();
                saveDataToLocalStorage();
            };

            const handleCalculate = () => {
                const rows = document.querySelectorAll('#product-table-body tr');
                let productsForCalc = [];
                const productNames = new Set();

                for (const row of rows) {
                    const nameInput = row.querySelector('.product-name');
                    const name = nameInput.value.trim();
                    if (name) {
                        if (productNames.has(name)) {
                            alert(`错误：产品 "${name}" 重复输入，请删除多余的行或修改名称。`);
                            nameInput.focus();
                            return;
                        }
                        productNames.add(name);
                        const holdingAmount = parseFloat(row.querySelector('.holding-amount').value) || 0;
                        const sinceInceptionYield = parseFloat(row.querySelector('.since-inception-yield').value) || 0;
                        const startValue = parseFloat(row.querySelector('.start-value').value);
                        const endValue = parseFloat(row.querySelector('.end-value').value);
                        const isSoldOut = row.querySelector('.sold-out-checkbox').checked;

                        if (!isNaN(startValue) && !isNaN(endValue) && startValue > 0) {
                            productsForCalc.push({ name, holdingAmount, sinceInceptionYield, startValue, endValue, isSoldOut });
                        } else {
                             productsForCalc.push({ name, holdingAmount, sinceInceptionYield, startValue: 0, endValue: 0, isSoldOut });
                        }
                    }
                }
                
                saveDataToLocalStorage(); 

                if (productsForCalc.length === 0) { 
                    alert('请输入有效的产品数据后再进行计算！'); 
                    return; 
                }
                
                const totalHoldingAmount = productsForCalc.reduce((sum, p) => sum + p.holdingAmount, 0);

                let resultsWithMetrics = productsForCalc.map(p => {
                    const sevenDayYield = p.startValue > 0 ? ((p.endValue - p.startValue) / p.startValue) / intervalDays * 365 * 100 : 0;
                    const comprehensiveScore = (sevenDayYield * 0.7) + (p.sinceInceptionYield * 0.3);
                    const holdingAmountPercentage = totalHoldingAmount > 0 ? (p.holdingAmount / totalHoldingAmount) * 100 : 0;
                    const isExcluded = p.isSoldOut && p.holdingAmount === 0;
                    return { ...p, yield: sevenDayYield, comprehensiveScore, holdingAmountPercentage, isExcluded };
                });
                
                const rankedProducts = resultsWithMetrics.filter(p => !p.isExcluded);
                const excludedProducts = resultsWithMetrics.filter(p => p.isExcluded);

                const sortedRankedByScore = [...rankedProducts].sort((a, b) => b.comprehensiveScore - a.comprehensiveScore);
                const scoreRankMap = new Map();
                sortedRankedByScore.forEach((p, index) => {
                    scoreRankMap.set(p.name, index);
                });

                const nonSoldOutProducts = sortedRankedByScore.filter(p => !p.isSoldOut);
                const addCandidateCount = Math.ceil(nonSoldOutProducts.length * 0.25);
                const addCandidates = nonSoldOutProducts.slice(0, addCandidateCount).map(p => p.name);
                
                const reduceStartIndex = Math.floor(nonSoldOutProducts.length * 0.75); 
                const bestAvailableScore = nonSoldOutProducts.length > 0 ? nonSoldOutProducts[0].comprehensiveScore : 0;

                const inceptionYieldRanked = [...rankedProducts].filter(p => p.sinceInceptionYield > 0).sort((a, b) => b.sinceInceptionYield - a.sinceInceptionYield);
                const inceptionRankMap = new Map();
                inceptionYieldRanked.forEach((p, index) => {
                    inceptionRankMap.set(p.name, index + 1);
                });

                const sevenDayYieldRanked = [...rankedProducts].sort((a, b) => b.yield - a.yield);
                const sevenDayRankMap = new Map();
                sevenDayYieldRanked.forEach((p, index) => {
                    sevenDayRankMap.set(p.name, index + 1);
                });

                let processedRankedProducts = rankedProducts.map(p => {
                    let rebalanceAction = null;
                    const itsRankIndex = scoreRankMap.get(p.name);
                    if (!p.isSoldOut) {
                        if (addCandidates.includes(p.name)) {
                            rebalanceAction = '加仓';
                        } else if (p.holdingAmount >= 1000 && itsRankIndex >= reduceStartIndex && bestAvailableScore > 0 && (bestAvailableScore - p.comprehensiveScore > 0.5)) {
                            rebalanceAction = '减仓';
                        }
                    }
                    return {
                        ...p,
                        inceptionRank: inceptionRankMap.get(p.name) || null,
                        sevenDayRank: sevenDayRankMap.get(p.name) || null,
                        rebalanceAction: rebalanceAction
                    };
                });
                
                lastCalculatedResults = [...processedRankedProducts.sort((a,b) => b.comprehensiveScore - a.comprehensiveScore), ...excludedProducts.sort((a,b) => b.comprehensiveScore - a.comprehensiveScore)];

                displayResults(lastCalculatedResults);
            };

            const displayResults = (results) => {
                const tableBody = document.getElementById('results-table-body');
                const isAmountHidden = document.getElementById('toggle-amount-visibility').checked;
                tableBody.innerHTML = '';
                let rankCounter = 0;
                results.forEach((p) => {
                    let rankDisplay;
                    let rankStyle = '';
                    let rowExtraClass = '';

                    if (p.isExcluded) {
                        rankDisplay = '-';
                        rowExtraClass = 'line-through text-gray-400';
                    } else {
                        rankCounter++;
                        rankDisplay = rankCounter;
                        rankStyle = rankCounter === 1 ? 'text-red-500 font-bold' : (rankCounter === 2 ? 'text-orange-500 font-semibold' : (rankCounter === 3 ? 'text-yellow-500' : ''));
                    }
                    
                    const soldOutText = p.isSoldOut ? '<span class="font-bold text-red-500">是</span>' : '<span class="text-green-600">否</span>';
                    
                    let holdingAmountFormatted = '***';
                    if (!isAmountHidden) {
                        holdingAmountFormatted = p.holdingAmount > 0 
                            ? `${p.holdingAmount.toLocaleString('en-US')} <span class="text-xs text-gray-400">(${p.holdingAmountPercentage.toFixed(2)}%)</span>` 
                            : '-';
                    }
                    
                    let sinceInceptionYieldFormatted = '-';
                    if (p.sinceInceptionYield > 0 || p.sinceInceptionYield === 0) {
                        sinceInceptionYieldFormatted = `${p.sinceInceptionYield.toFixed(2)}%`;
                        if (p.inceptionRank) {
                            sinceInceptionYieldFormatted += ` <span class="text-xs text-gray-400">(${p.inceptionRank})</span>`;
                        }
                    }
                    
                    let sevenDayYieldFormatted = '-';
                    if (p.startValue > 0 || p.yield === 0) {
                        sevenDayYieldFormatted = `${p.yield.toFixed(2)}%`;
                        if(p.sevenDayRank) {
                            sevenDayYieldFormatted += ` <span class="text-xs text-gray-400">(${p.sevenDayRank})</span>`;
                        }
                    }

                    let actionIcon = '';
                    let rowBgClass = '';
                    if (p.rebalanceAction === '减仓') {
                        actionIcon = `<div class="text-xs text-yellow-600 font-bold" title="建议减仓">减仓</div>`;
                        rowBgClass = 'bg-yellow-100';
                    } else if (p.rebalanceAction === '加仓') {
                        actionIcon = `<div class="text-xs text-green-600 font-bold" title="建议加仓">加仓</div>`;
                        rowBgClass = 'bg-green-100';
                    }

                    const tr = document.createElement('tr');
                    tr.className = `border-b hover:bg-gray-50 ${rowBgClass} ${rowExtraClass}`;
                    tr.innerHTML = `
                        <td class="p-3 text-center ${rankStyle}">
                            ${rankDisplay}
                            ${actionIcon}
                        </td>
                        <td class="p-3 font-medium">${p.name}</td>
                        <td class="p-3 text-right">${holdingAmountFormatted}</td>
                        <td class="p-3 text-right text-gray-500">${sinceInceptionYieldFormatted}</td>
                        <td class="p-3 text-right font-semibold text-green-600">${sevenDayYieldFormatted}</td>
                        <td class="p-3 text-right font-bold text-blue-600">${p.comprehensiveScore.toFixed(2)}</td>
                        <td class="p-3 text-center">${soldOutText}</td>
                    `;
                    tableBody.appendChild(tr);
                });
                displayChart(results.filter(p => !p.isExcluded));
                displayInstitutionChart(results);
                document.getElementById('results-section').classList.remove('hidden');
            };

            const displayChart = (results) => {
                const ctx = document.getElementById('yield-chart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                
                const displayData = [...results].sort((a,b) => b.comprehensiveScore - a.comprehensiveScore);

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: displayData.map(p => p.name),
                        datasets: [{ label: '综合分数', data: displayData.map(p => p.comprehensiveScore.toFixed(2)), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` ${c.dataset.label}: ${c.raw}` } } },
                        scales: { 
                            x: { title: { display: true, text: '综合分数' } },
                            y: { ticks: { autoSkip: false } }
                        }
                    }
                });
            };

            const displayInstitutionChart = (results) => {
                const container = document.getElementById('institution-chart-container');
                const ctx = document.getElementById('institution-chart').getContext('2d');
                if (institutionChartInstance) institutionChartInstance.destroy();

                const institutionHoldings = {};
                results.forEach(p => {
                    if (p.holdingAmount > 0) {
                        const institutionName = p.name.split(' ')[0]; // Extract institution name
                        if (!institutionHoldings[institutionName]) {
                            institutionHoldings[institutionName] = 0;
                        }
                        institutionHoldings[institutionName] += p.holdingAmount;
                    }
                });

                const holdingData = Object.keys(institutionHoldings).map(name => ({ name, amount: institutionHoldings[name] }));

                if (holdingData.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                container.style.display = 'block';

                const totalHolding = holdingData.reduce((sum, p) => sum + p.amount, 0);

                institutionChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: holdingData.map(p => p.name),
                        datasets: [{
                            label: '持仓金额',
                            data: holdingData.map(p => p.amount),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
                                'rgba(199, 199, 199, 0.8)', 'rgba(83, 102, 255, 0.8)', 'rgba(40, 159, 64, 0.8)'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.raw;
                                        const percentage = ((value / totalHolding) * 100).toFixed(2);
                                        return `${label}${value.toLocaleString('en-US')}元 (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            };
            
            const handleExportTable = () => {
                const container = document.getElementById('export-container');
                const content = document.getElementById('export-content');
                const title = document.getElementById('export-title');
                const dateEl = document.getElementById('export-date');
                
                const results = Array.from(document.querySelectorAll('#results-table-body tr')).map(row => ({
                    rank: row.children[0].textContent.trim(),
                    name: row.children[1].textContent,
                    holdingAmount: row.children[2].innerHTML,
                    sinceInceptionYield: row.children[3].innerHTML,
                    yield: row.children[4].innerHTML,
                    comprehensiveScore: row.children[5].textContent,
                    isSoldOut: row.children[6].textContent,
                    rebalanceAction: row.children[0].querySelector('div')?.textContent || ''
                }));

                if(results.length === 0) { alert('没有可导出的结果！'); return; }
                
                title.textContent = '活期+plus 调仓决策表';
                dateEl.textContent = `数据截止: ${document.getElementById('end-date-display').textContent}`;
                content.innerHTML = ''; 

                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.innerHTML = `
                    <thead style="text-align: left; border-bottom: 1px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 8px; width: 8%;">排名</th>
                            <th style="padding: 8px; width: 28%;">产品名称</th>
                            <th style="padding: 8px; width: 14%; text-align: right;">持有金额</th>
                            <th style="padding: 8px; width: 14%; text-align: right;">成立以来(%)</th>
                            <th style="padding: 8px; width: 14%; text-align: right;">近7日(%)</th>
                            <th style="padding: 8px; width: 12%; text-align: right;">综合分数</th>
                            <th style="padding: 8px; width: 10%; text-align: center;">售罄</th>
                        </tr>
                    </thead>
                `;
                const tbody = document.createElement('tbody');
                results.forEach(p => {
                    const rankColor = p.rank.startsWith('1') ? '#ef4444' : (p.rank.startsWith('2') ? '#f97316' : (p.rank.startsWith('3') ? '#eab308' : '#374151'));
                    const soldOutColor = p.isSoldOut === '是' ? '#ef4444' : '#16a34a';
                    const item = document.createElement('tr');

                    if (p.rebalanceAction === '减仓') {
                        item.style.backgroundColor = '#fef9c3'; // Light yellow
                    } else if (p.rebalanceAction === '加仓') {
                        item.style.backgroundColor = '#dcfce7'; // Light green
                    }

                    item.innerHTML = `
                        <td style="padding: 8px; text-align: center; font-weight: bold; color: ${rankColor};">${p.rank}</td>
                        <td style="padding: 8px;">${p.name}</td>
                        <td style="padding: 8px; text-align: right;">${p.holdingAmount}</td>
                        <td style="padding: 8px; text-align: right; color: #6b7280;">${p.sinceInceptionYield}</td>
                        <td style="padding: 8px; font-weight: bold; color: #16a34a; text-align: right;">${p.yield}</td>
                        <td style="padding: 8px; font-weight: bold; color: #3b82f6; text-align: right;">${p.comprehensiveScore}</td>
                        <td style="padding: 8px; text-align: center; font-weight: bold; color: ${soldOutColor};">${p.isSoldOut}</td>
                    `;
                    tbody.appendChild(item);
                });
                table.appendChild(tbody);
                content.appendChild(table);

                html2canvas(container).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `活期plus调仓决策表-${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            };
            
            const handleExportChart = () => {
                const canvas = document.getElementById('yield-chart');
                if (!chartInstance || chartInstance.data.labels.length === 0) {
                    alert('没有可导出的图表！');
                    return;
                }
                const link = document.createElement('a');
                link.download = `活期plus综合分数图表-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png', 1.0); 
                link.click();
            };
            
            const handleExportToCsv = () => {
                const rows = document.querySelectorAll('#product-table-body tr');
                const data = [];
                const header = ['产品名称', '持有金额', '成立以来年化(%)', '起始净值', '最新净值', '是否售罄'];
                data.push(header);

                rows.forEach(row => {
                    const name = row.querySelector('.product-name').value.trim();
                    if(name) {
                        const holdingAmount = row.querySelector('.holding-amount').value;
                        const sinceInceptionYield = row.querySelector('.since-inception-yield').value;
                        const startVal = row.querySelector('.start-value').value;
                        const endVal = row.querySelector('.end-value').value;
                        const isSoldOut = row.querySelector('.sold-out-checkbox').checked ? '是' : '否';
                        data.push([name, holdingAmount, sinceInceptionYield, startVal, endVal, isSoldOut]);
                    }
                });

                if (data.length <= 1) {
                    alert('没有数据可导出！');
                    return;
                }

                let csvContent = data.map(e => e.map(item => `"${item}"`).join(",")).join("\n");
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `调仓数据-${new Date().toISOString().slice(0,10)}.csv`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const handleImportFromCsv = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const rows = text.split('\n').slice(1);
                    
                    document.getElementById('product-table-body').innerHTML = '';
                    
                    rows.forEach(rowStr => {
                        if (rowStr.trim() === '') return;
                        const columns = rowStr.split(',').map(cell => cell.trim().replace(/"/g, ''));
                        if (columns.length >= 6) {
                            const productData = {
                                name: columns[0],
                                holdingAmount: columns[1],
                                sinceInceptionYield: columns[2],
                                startVal: columns[3],
                                endVal: columns[4],
                                isSoldOut: columns[5] === '是'
                            };
                            createTableRow(productData);
                        }
                    });
                    updateRowButtonsState();
                    saveDataToLocalStorage();
                    alert(`成功从CSV文件导入 ${rows.length} 条数据！`);
                };
                reader.readAsText(file, 'UTF-8');
                event.target.value = '';
            };


            const sortTableByName = () => {
                const tableBody = document.getElementById('product-table-body');
                const rows = Array.from(tableBody.querySelectorAll('tr'));

                const rowsToSort = rows.filter(row => row.querySelector('.product-name').value.trim() !== '');
                const emptyRow = rows.find(row => row.querySelector('.product-name').value.trim() === '');

                rowsToSort.sort((a, b) => {
                    const nameA = a.querySelector('.product-name').value.trim();
                    const nameB = b.querySelector('.product-name').value.trim();
                    
                    return nameSortDirection === 'asc' 
                        ? nameA.localeCompare(nameB, 'zh-CN') 
                        : nameB.localeCompare(nameA, 'zh-CN');
                });

                tableBody.innerHTML = '';
                rowsToSort.forEach(row => tableBody.appendChild(row));
                if (emptyRow) tableBody.appendChild(emptyRow);

                const sortIndicator = document.getElementById('sort-indicator');
                sortIndicator.innerHTML = nameSortDirection === 'asc' 
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>' 
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>';

                nameSortDirection = nameSortDirection === 'asc' ? 'desc' : 'asc';
                
                updateRowButtonsState();
                saveDataToLocalStorage();
            };
            
            const handleAmountVisibilityToggle = () => {
                localStorage.setItem(AMOUNT_VISIBILITY_KEY, document.getElementById('toggle-amount-visibility').checked);
                if (lastCalculatedResults.length > 0) {
                    displayResults(lastCalculatedResults);
                }
            };

            // --- 页面初始化 ---
            document.getElementById('product-table-body').addEventListener('click', handleTableActions);
            document.getElementById('add-row-btn').addEventListener('click', () => {
                createTableRow();
                updateRowButtonsState();
            });
            document.getElementById('calculate-btn').addEventListener('click', handleCalculate);
            document.getElementById('export-table-btn').addEventListener('click', handleExportTable);
            document.getElementById('export-chart-btn').addEventListener('click', handleExportChart);
            document.getElementById('export-csv-btn').addEventListener('click', handleExportToCsv);
            document.getElementById('import-csv-input').addEventListener('change', handleImportFromCsv);
            document.getElementById('sort-by-name-header').addEventListener('click', sortTableByName);
            document.getElementById('toggle-amount-visibility').addEventListener('change', handleAmountVisibilityToggle);

            const isAmountHiddenSaved = localStorage.getItem(AMOUNT_VISIBILITY_KEY) === 'true';
            document.getElementById('toggle-amount-visibility').checked = isAmountHiddenSaved;

            setupDates();
            loadDataFromLocalStorage();
        });
    </script>
</body>
</html>
